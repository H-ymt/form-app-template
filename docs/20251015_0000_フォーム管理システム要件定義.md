# フォーム管理システム要件定義書

作成日: 2025-10-15

## 1. プロジェクト概要

### 1.1 目的

汎用的なフォーム送信を受け付け、管理画面で閲覧・CSV 出力できるシステムを構築する。

### 1.2 システム構成

- **モノレポ構成**: Cloudflare Workers へのデプロイを前提
- **管理画面**: React + TypeScript + Tanstack Router
- **API**: フォーム送信を受け付けるエンドポイント
- **フロントエンド**: 静的 HTML、Astro、Next.js など任意(POST 送信)

---

## 2. 技術スタック

### 2.1 共通

- **言語**: TypeScript
- **デプロイ先**: Cloudflare Workers
- **モノレポ管理**: pnpm workspaces

### 2.2 管理画面 (Admin)

- **フレームワーク**: React + TypeScript
- **ルーティング**: Tanstack Router
- **スタイリング**: Tailwind CSS v4
- **メール送信**: Resend (通知用オプション)

### 2.3 API (Backend)

- **ランタイム**: Cloudflare Workers
- **データストア**: Cloudflare D1 (SQLite) または KV
- **バリデーション**: Zod
- **CORS**: 設定可能

---

## 3. 機能要件

### 3.1 API 機能

#### 3.1.1 フォーム送信エンドポイント

- **エンドポイント**: `POST /api/forms/submit`
- **リクエスト形式**: JSON または FormData
- **必須項目**:
  - `formId`: フォーム識別子 (string)
  - 任意のフィールド (動的に受付)
- **処理内容**:
  - 送信データをデータストアに保存
  - タイムスタンプ、送信元 IP アドレスを記録
  - (オプション) Resend 経由で通知メール送信
- **レスポンス**:
  - 成功: `{ success: true, submissionId: string }`
  - 失敗: `{ success: false, error: string }`

#### 3.1.2 CORS 設定

- 許可オリジンを環境変数で設定可能
- プレフライトリクエスト対応

#### 3.1.3 レート制限

- IP 単位でのレート制限 (例: 10req/分)
- Cloudflare Workers の機能を活用

---

### 3.2 管理画面機能

#### 3.2.1 認証機能

- **最小限の実装**: Basic 認証 または 固定トークン認証
- 環境変数でユーザー名・パスワードを設定
- ログイン画面 (`/login`)

#### 3.2.2 フォーム送信一覧

- **パス**: `/` (ルート)
- **表示内容**:
  - 送信日時
  - フォーム ID
  - 送信者情報(IP 等)
  - データプレビュー(一部表示)
- **機能**:
  - ページネーション (1 ページ 20 件)
  - 日付範囲フィルター
  - フォーム ID 別フィルター
  - 検索機能(任意フィールド)

#### 3.2.3 詳細表示

- **パス**: `/submissions/:id`
- **表示内容**:
  - 全フィールドの詳細表示
  - メタデータ(送信日時、IP、User-Agent 等)
- **機能**:
  - 削除ボタン(確認ダイアログ付き)

#### 3.2.4 CSV 出力

- **場所**: 一覧画面にボタン配置
- **機能**:
  - 現在のフィルター条件に基づくデータを出力
  - 全フィールドを列として含む
  - UTF-8 BOM 付きで出力(Excel 互換)
  - ファイル名: `form-submissions-{YYYYMMDD-HHMMSS}.csv`

#### 3.2.5 統計ダッシュボード (オプション)

- **パス**: `/dashboard`
- **表示内容**:
  - 総送信数
  - 直近 7 日間の送信推移グラフ
  - フォーム ID 別の送信数

---

## 4. 非機能要件

### 4.1 パフォーマンス

- 管理画面の初回表示: 2 秒以内
- API レスポンス: 500ms 以内
- 大量データ(10,000 件以上)でも快適な一覧表示

### 4.2 セキュリティ

- 管理画面への認証必須
- API のレート制限
- 入力値のサニタイゼーション
- HTTPS 必須
- 環境変数での機密情報管理

### 4.3 可用性

- Cloudflare Workers の SLA に準拠
- データバックアップ戦略(D1 の場合は定期的なエクスポート)

### 4.4 スケーラビリティ

- Cloudflare Workers のエッジネットワークを活用
- D1 の制限(5GB、1 秒あたり 25MB)を考慮

### 4.5 保守性

- TypeScript による型安全性
- ESLint、Prettier によるコード品質維持
- 明確なディレクトリ構造

---

## 5. データモデル

### 5.1 フォーム送信データ (form_submissions)

```typescript
interface FormSubmission {
  id: string; // UUID
  formId: string; // フォーム識別子
  data: Record<string, unknown>; // 動的なフォームデータ
  metadata: {
    ipAddress: string;
    userAgent: string;
    referrer?: string;
  };
  createdAt: string; // ISO 8601
}
```

### 5.2 D1 テーブル定義

```sql
CREATE TABLE form_submissions (
  id TEXT PRIMARY KEY,
  form_id TEXT NOT NULL,
  data TEXT NOT NULL, -- JSON文字列
  ip_address TEXT,
  user_agent TEXT,
  referrer TEXT,
  created_at TEXT NOT NULL,
  INDEX idx_form_id (form_id),
  INDEX idx_created_at (created_at)
);
```

---

## 6. ディレクトリ構成

```
form-app-template/
├── packages/
│   ├── admin/                  # 管理画面
│   │   ├── src/
│   │   │   ├── routes/         # Tanstack Router
│   │   │   ├── components/     # React コンポーネント
│   │   │   ├── hooks/          # カスタムフック
│   │   │   ├── lib/            # ユーティリティ
│   │   │   ├── types/          # 型定義
│   │   │   └── main.tsx
│   │   ├── public/
│   │   ├── wrangler.toml
│   │   └── package.json
│   │
│   ├── api/                    # API (Workers)
│   │   ├── src/
│   │   │   ├── handlers/       # エンドポイントハンドラ
│   │   │   ├── middleware/     # 認証・CORS等
│   │   │   ├── services/       # ビジネスロジック
│   │   │   ├── repositories/   # データアクセス
│   │   │   ├── types/          # 型定義
│   │   │   └── index.ts
│   │   ├── schema.sql          # D1スキーマ
│   │   ├── wrangler.toml
│   │   └── package.json
│   │
│   └── shared/                 # 共通型定義
│       ├── src/
│       │   └── types/
│       └── package.json
│
├── examples/                   # フォーム送信サンプル
│   ├── static-html/
│   ├── astro/
│   └── nextjs/
│
├── docs/                       # ドキュメント
├── package.json                # ルート
├── pnpm-workspace.yaml         # pnpm workspaces設定
└── README.md
```

---

## 7. 画面設計

### 7.1 ログイン画面 (`/login`)

- ユーザー名・パスワード入力フォーム
- ログインボタン
- エラーメッセージ表示

### 7.2 一覧画面 (`/`)

- ヘッダー: タイトル、ログアウトボタン
- フィルター: 日付範囲、フォーム ID、検索ボックス
- テーブル:
  - 列: 送信日時、フォーム ID、プレビュー、アクション
  - 各行に「詳細」リンク
- ページネーション
- CSV 出力ボタン

### 7.3 詳細画面 (`/submissions/:id`)

- 戻るボタン
- メタデータ表示エリア
- フィールド一覧(キー・値のテーブル)
- 削除ボタン

---

## 8. API 仕様

### 8.1 フォーム送信

**エンドポイント**: `POST /api/forms/submit`

**リクエストヘッダー**:

```
Content-Type: application/json
```

**リクエストボディ**:

```json
{
  "formId": "contact-form",
  "name": "山田太郎",
  "email": "yamada@example.com",
  "message": "お問い合わせ内容"
}
```

**レスポンス** (成功):

```json
{
  "success": true,
  "submissionId": "uuid-here"
}
```

**レスポンス** (失敗):

```json
{
  "success": false,
  "error": "Invalid request"
}
```

### 8.2 送信一覧取得 (管理画面用)

**エンドポイント**: `GET /api/admin/submissions`

**クエリパラメータ**:

- `page`: ページ番号 (default: 1)
- `limit`: 1 ページあたりの件数 (default: 20)
- `formId`: フォーム ID でフィルター (optional)
- `startDate`: 開始日 (ISO 8601) (optional)
- `endDate`: 終了日 (ISO 8601) (optional)
- `search`: 検索キーワード (optional)

**認証**: Basic 認証 または Bearer トークン

**レスポンス**:

```json
{
  "data": [
    {
      "id": "uuid",
      "formId": "contact-form",
      "data": { "name": "山田太郎", ... },
      "metadata": { "ipAddress": "192.0.2.1", ... },
      "createdAt": "2025-10-15T12:00:00Z"
    }
  ],
  "pagination": {
    "currentPage": 1,
    "totalPages": 10,
    "totalItems": 200,
    "limit": 20
  }
}
```

### 8.3 詳細取得

**エンドポイント**: `GET /api/admin/submissions/:id`

**認証**: Basic 認証 または Bearer トークン

**レスポンス**:

```json
{
  "id": "uuid",
  "formId": "contact-form",
  "data": { "name": "山田太郎", "email": "yamada@example.com", "message": "..." },
  "metadata": {
    "ipAddress": "192.0.2.1",
    "userAgent": "Mozilla/5.0...",
    "referrer": "https://example.com"
  },
  "createdAt": "2025-10-15T12:00:00Z"
}
```

### 8.4 削除

**エンドポイント**: `DELETE /api/admin/submissions/:id`

**認証**: Basic 認証 または Bearer トークン

**レスポンス**:

```json
{
  "success": true
}
```

---

## 9. デプロイ戦略

### 9.1 環境

- **開発**: ローカル開発環境 (Wrangler dev)
- **本番**: Cloudflare Workers

### 9.2 環境変数

#### API (workers)

```
# D1 データベース
DATABASE_ID=xxx

# 認証
ADMIN_USERNAME=admin
ADMIN_PASSWORD=secure-password

# CORS
ALLOWED_ORIGINS=https://example.com,https://example2.com

# Resend (オプション)
RESEND_API_KEY=xxx
NOTIFICATION_EMAIL=admin@example.com
```

#### Admin (workers)

```
# API エンドポイント
API_URL=https://api.example.com

# 認証
ADMIN_USERNAME=admin
ADMIN_PASSWORD=secure-password
```

### 9.3 デプロイコマンド

```bash
# API
cd packages/api
pnpm run deploy

# Admin
cd packages/admin
pnpm run deploy
```

---

## 10. 今後の拡張性

### 10.1 優先度: 中

- Webhook 機能(送信時に外部 URL へ POST)
- フォーム別の設定管理(通知先メール、バリデーションルール)
- ファイルアップロード対応(Cloudflare R2)

### 10.2 優先度: 低

- 複数管理者アカウント
- ロールベースアクセス制御
- 送信データの暗号化
- より詳細な統計・分析機能

---

## 11. 制約事項

- Cloudflare Workers の実行時間制限: CPU 時間 50ms (無料プラン)、10ms (有料プラン)
- D1 のストレージ制限: 5GB (プランによる)
- Resend の送信制限: 月 100 通(無料プラン)

---

## 12. 成果物

### 12.1 納品物

- モノレポ構成のソースコード
- README.md (セットアップ手順)
- 本要件定義書
- API 仕様書(別途詳細版)

### 12.2 ドキュメント

- セットアップガイド
- デプロイ手順書
- フロントエンド実装例(HTML/Astro/Next.js)

---

## 13. スケジュール(参考)

| フェーズ         | 内容                      | 期間 |
| ---------------- | ------------------------- | ---- |
| 設計             | 要件定義、技術選定        | 完了 |
| 基盤構築         | モノレポ、D1 セットアップ | 1 日 |
| API 開発         | エンドポイント実装        | 2 日 |
| 管理画面開発     | React UI 実装             | 3 日 |
| 統合テスト       | E2E、負荷テスト           | 1 日 |
| ドキュメント作成 | README、手順書            | 1 日 |

**合計**: 約 8 日間

---

## 付録 A: 参考リンク

- [Cloudflare Workers Docs](https://developers.cloudflare.com/workers/)
- [Cloudflare D1 Docs](https://developers.cloudflare.com/d1/)
- [Tanstack Router](https://tanstack.com/router/latest)
- [Tailwind CSS v4](https://tailwindcss.com/)
- [Resend](https://resend.com/docs)

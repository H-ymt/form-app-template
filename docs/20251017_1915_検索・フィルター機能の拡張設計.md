# 検索・フィルター機能の拡張設計

## 概要

管理画面の一覧表示で、より詳細な検索・フィルター機能を実装し、ユーザーが目的のフォーム送信データを効率的に見つけられるようにする。

**関連Issue**: #5
**優先度**: 🔴 高優先度
**作成日**: 2025-10-17

---

## 現状分析

### 既に実装されている機能

#### API側（apps/api）
- `ListSubmissionsQuery`型に以下のフィルターパラメータが定義済み:
  - `formId`: フォームIDによるフィルター
  - `startDate`: 開始日によるフィルター
  - `endDate`: 終了日によるフィルター
  - `search`: キーワード検索（form_idとdataカラムを対象）

- `SubmissionRepository.list()`メソッドで上記パラメータに対応したSQL WHERE句を構築
  - キーワード検索は`LIKE`演算子を使用

#### フロントエンド側（apps/admin）
- `formIdFilter`によるフィルタリングのみ実装済み
- クリアボタンあり
- ページネーション実装済み

### 実装が必要な機能

1. 日付範囲フィルター（開始日・終了日）のUI
2. キーワード検索のUI
3. 複数条件の組み合わせ
4. フィルタークリアボタンの拡張
5. URLクエリパラメータでの状態保存

---

## 設計詳細

### 1. UI/UXデザイン

#### フィルターエリアのレイアウト

```text
┌─────────────────────────────────────────────────────────────┐
│ フィルター                                                  │
├─────────────────────────────────────────────────────────────┤
│ フォームID: [___________________]                           │
│                                                              │
│ 日付範囲:  [開始日: ____] 〜 [終了日: ____]                 │
│                                                              │
│ キーワード検索: [_________________________]                 │
│ ※フォームIDまたはフォームデータ内を検索                     │
│                                                              │
│                       [検索] [クリア]                        │
└─────────────────────────────────────────────────────────────┘
```

#### フィルターの動作仕様

- **リアルタイム検索 vs ボタン式検索**
  - 現在: formIdはリアルタイム（入力のたびに検索）
  - 提案: 日付・キーワードを追加するため、「検索」ボタン方式に統一
  - 理由: 複数条件を設定してから一度に検索する方がUX向上

- **クリアボタン**
  - すべてのフィルター条件を一度にクリア
  - ページ番号も1にリセット

### 2. 状態管理

#### State設計

```typescript
interface FilterState {
  formId: string;
  startDate: string; // YYYY-MM-DD形式
  endDate: string;   // YYYY-MM-DD形式
  keyword: string;   // キーワード検索
}

const [filters, setFilters] = useState<FilterState>({
  formId: '',
  startDate: '',
  endDate: '',
  keyword: '',
});
```

#### URLクエリパラメータとの同期

Tanstack Routerの`searchParams`を活用して、フィルター状態をURLに反映:

```typescript
// URLパラメータの型定義
type SearchParams = {
  page?: number;
  formId?: string;
  startDate?: string;
  endDate?: string;
  keyword?: string;
};

// Route定義時にvalidateSearchを使用
export const Route = createFileRoute('/')({
  validateSearch: (search: Record<string, unknown>): SearchParams => {
    return {
      page: Number(search?.page) || undefined,
      formId: (search?.formId as string) || undefined,
      startDate: (search?.startDate as string) || undefined,
      endDate: (search?.endDate as string) || undefined,
      keyword: (search?.keyword as string) || undefined,
    };
  },
  component: Index,
});
```

**メリット**:
- ブラウザの戻る/進むボタンでフィルター状態が保持される
- URLをブックマーク・共有できる
- リロード時にフィルター状態が復元される

### 3. API連携

#### リクエスト例

```typescript
// 現在のlistSubmissions関数はそのまま使用可能
const response = await listSubmissions({
  page: 1,
  limit: 20,
  formId: 'contact-form',
  startDate: '2025-01-01',
  endDate: '2025-12-31',
  search: 'example@email.com',
});
```

#### 日付フォーマット

- 入力: `<input type="date">` → `YYYY-MM-DD`形式
- API送信: ISO8601形式に変換 → `YYYY-MM-DDT00:00:00.000Z`
- DB保存形式: ISO8601 (`created_at`カラム)

**変換ロジック**:
```typescript
function formatDateForAPI(dateString: string): string {
  if (!dateString) return '';
  // YYYY-MM-DD → YYYY-MM-DDT00:00:00.000Z
  return new Date(`${dateString}T00:00:00.000Z`).toISOString();
}
```

### 4. バリデーション

#### クライアントサイドバリデーション

```typescript
function validateFilters(filters: FilterState): {
  isValid: boolean;
  errors: string[];
} {
  const errors: string[] = [];

  // 日付の妥当性チェック
  if (filters.startDate && filters.endDate) {
    const start = new Date(filters.startDate);
    const end = new Date(filters.endDate);

    if (start > end) {
      errors.push('開始日は終了日より前の日付を指定してください');
    }
  }

  // 未来の日付チェック
  const today = new Date();
  if (filters.startDate && new Date(filters.startDate) > today) {
    errors.push('開始日に未来の日付は指定できません');
  }

  if (filters.endDate && new Date(filters.endDate) > today) {
    errors.push('終了日に未来の日付は指定できません');
  }

  return {
    isValid: errors.length === 0,
    errors,
  };
}
```

### 5. パフォーマンス考慮事項

#### データベースインデックス

現在のスキーマ（apps/api/schema.sql）には以下のインデックスが存在:
```sql
CREATE INDEX IF NOT EXISTS idx_form_id ON form_submissions(form_id);
CREATE INDEX IF NOT EXISTS idx_created_at ON form_submissions(created_at);
```

**検討事項**:
- `data`カラムはJSONテキストのため、LIKE検索のパフォーマンスは要注意
- 大量データ（10万件以上）の場合、全文検索エンジン（Cloudflare D1の制約により難しい）やキャッシュ戦略を検討

#### フロントエンドのデバウンス

キーワード検索入力時のリアルタイム検索を実装する場合:
```typescript
import { useDebouncedCallback } from 'use-debounce';

const debouncedSearch = useDebouncedCallback((value: string) => {
  // 検索処理
}, 500); // 500ms待機
```

ただし、今回は「検索」ボタン方式を推奨するため不要。

---

## 実装計画

### Phase 1: 基本フィルター機能（必須）

#### 1.1 フロントエンド実装

**ファイル**: `apps/admin/src/routes/index.tsx`

- [ ] `FilterState`の型定義と状態管理
- [ ] 日付入力フィールドの追加（開始日・終了日）
- [ ] キーワード検索入力フィールドの追加
- [ ] 「検索」ボタンの実装（フィルター適用）
- [ ] 「クリア」ボタンの拡張（全フィルターリセット）
- [ ] フィルター適用時にページ番号を1にリセット

#### 1.2 URLクエリパラメータ連携

**ファイル**: `apps/admin/src/routes/index.tsx`

- [ ] Tanstack Routerの`validateSearch`実装
- [ ] `useSearch()`でURLパラメータを取得
- [ ] `useNavigate()`でURLパラメータを更新
- [ ] 初回レンダリング時にURLパラメータからフィルター状態を復元

#### 1.3 バリデーション実装

**ファイル**: `apps/admin/src/routes/index.tsx`

- [ ] 日付範囲のバリデーションロジック
- [ ] エラーメッセージの表示UI
- [ ] バリデーションエラー時は検索を実行しない

### Phase 2: UX改善（推奨）

#### 2.1 レスポンシブデザイン

- [ ] モバイル表示時のフィルターUIの最適化
- [ ] フィルターの開閉機能（アコーディオン）

#### 2.2 フィルター適用状態の可視化

- [ ] アクティブなフィルター条件をバッジ表示
  ```text
  [フォームID: contact] [期間: 2025-01-01〜2025-12-31] [×]
  ```

#### 2.3 ローディング状態の改善

- [ ] フィルター適用中のスケルトンスクリーン表示
- [ ] 検索ボタンのローディング状態

### Phase 3: 高度な機能（オプション）

#### 3.1 フィルター条件の保存

- [ ] LocalStorageにフィルター条件を保存
- [ ] 次回アクセス時に前回のフィルターを復元

#### 3.2 プリセットフィルター

- [ ] 「今日」「今週」「今月」などのクイックフィルター
- [ ] よく使うフィルター条件の保存機能

---

## コンポーネント設計

### FilterForm コンポーネント（新規作成推奨）

```typescript
// apps/admin/src/components/FilterForm.tsx

interface FilterFormProps {
  filters: FilterState;
  onFilterChange: (filters: FilterState) => void;
  onSearch: () => void;
  onClear: () => void;
  errors?: string[];
}

export function FilterForm({
  filters,
  onFilterChange,
  onSearch,
  onClear,
  errors = [],
}: FilterFormProps) {
  // 実装
}
```

**メリット**:
- `index.tsx`の肥大化を防ぐ
- フィルターロジックの再利用性向上
- テストが書きやすい

---

## テストシナリオ

### 単体テスト

1. **バリデーション**
   - 開始日 > 終了日 → エラー
   - 未来の日付 → エラー
   - 正常な日付範囲 → OK

2. **フィルター状態管理**
   - フィルター変更時に状態が更新される
   - クリアボタンで全フィルターがリセットされる

### 結合テスト

1. **URLパラメータ連携**
   - フィルター適用時にURLが更新される
   - URL直接アクセス時にフィルターが復元される
   - ブラウザバック時にフィルター状態が戻る

2. **API連携**
   - 各フィルター条件でAPIリクエストが正しく送信される
   - 複数条件の組み合わせが正しく動作する

### E2Eテスト（将来）

1. フォームIDで絞り込み → 結果確認
2. 日付範囲で絞り込み → 結果確認
3. キーワード検索 → 結果確認
4. 全条件組み合わせ → 結果確認
5. クリアボタン → 全条件リセット確認

---

## セキュリティ考慮事項

### SQLインジェクション対策

- **現状**: プリペアドステートメント（`?`プレースホルダー）使用済み ✅
- **追加対策不要**: D1のバインディング機構が安全性を保証

### XSS対策

- **キーワード検索結果の表示**
  - Reactのデフォルトエスケープに依存 ✅
  - `dangerouslySetInnerHTML`は使用しない

---

## パフォーマンス最適化

### 初期表示の最適化

- **問題**: フィルター条件が多いと初回レンダリングが遅くなる可能性
- **対策**: フィルターフォームを`React.memo()`でメモ化

```typescript
export const FilterForm = React.memo(FilterFormComponent);
```

### API呼び出しの最適化

- **問題**: フィルター変更のたびにAPI呼び出し → 不要なリクエスト
- **対策**: 「検索」ボタン方式の採用（Phase 1で対応済み）

### ページネーション時の挙動

- フィルター変更時は必ずページ1に戻る
- ページ遷移時はフィルター条件を維持

---

## 制約事項・注意点

### Cloudflare D1の制限

- **全文検索**: D1はFTS（Full-Text Search）をサポートしていない
- **LIKE検索の性能**: 大規模データでは遅くなる可能性
- **対策**: データ量に応じて、外部検索サービス（Algolia等）の検討

### 日付のタイムゾーン

- **問題**: ユーザーのタイムゾーンとサーバー（UTC）のズレ
- **現状**: DBにはISO8601（UTC）で保存
- **表示**: `toLocaleString('ja-JP')`で日本時間表示
- **検索**: 日付範囲検索は日付のみ（時刻は00:00:00）で比較

**例**:
- ユーザー入力: `2025-10-17`
- API送信: `2025-10-17T00:00:00.000Z`（UTC）
- DB比較: `created_at >= '2025-10-17T00:00:00.000Z'`

### レスポンシブデザイン

- モバイル表示時のフィルターフォームの高さ
- 狭い画面では日付入力が2行になる可能性 → Flexboxで対応

---

## マイルストーン

### 第1週: Phase 1実装
- [ ] 日付範囲フィルターUI実装
- [ ] キーワード検索UI実装
- [ ] URLクエリパラメータ連携
- [ ] バリデーション実装

### 第2週: Phase 2実装
- [ ] レスポンシブデザイン対応
- [ ] フィルター状態の可視化
- [ ] ローディングUI改善

### 第3週以降: Phase 3（オプション）
- [ ] LocalStorageでのフィルター保存
- [ ] プリセットフィルター機能

---

## 参考資料

### 技術ドキュメント
- [Tanstack Router - Search Params](https://tanstack.com/router/latest/docs/framework/react/guide/search-params)
- [Cloudflare D1 - Query API](https://developers.cloudflare.com/d1/platform/client-api/)
- [MDN - input type="date"](https://developer.mozilla.org/ja/docs/Web/HTML/Element/input/date)

### 類似実装例
- React Admin Dashboard のフィルター機能
- SaaSアプリケーションのログ検索機能

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 担当者 |
|------|-----------|---------|--------|
| 2025-10-17 | 1.0 | 初版作成 | Claude |

---

## 承認

- [ ] プロダクトオーナー承認
- [ ] 技術リード承認
- [ ] 実装開始承認
